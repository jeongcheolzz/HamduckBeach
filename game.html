<!DOCTYPE html>
<html lang="ko">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>ê°ˆë§¤ê¸° í”¼í•˜ê¸° - ê²Œì„</title>
    <style>
      :root {
        --bg-overlay: rgba(0, 0, 0, 0.35);
        --panel-bg: rgba(255, 255, 255, 0.97);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: 'Gowun Dodum', 'Jua', sans-serif;
        background: #000;
        overflow: hidden;
      }
      #game-wrap {
        position: relative;
        width: 100vw;
        height: 100vh;
        touch-action: none;
        background: url('íŒŒë„.gif') center/cover no-repeat fixed;
      }

      /* ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ (ìš°ì¸¡ ìƒë‹¨) */
      .sound-controls {
        position: absolute;
        top: 4vh;
        right: 4vw;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 50;
        font-size: 3.6vw;
      }
      .sound-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.75);
        cursor: pointer;
        user-select: none;
      }
      .sound-btn img {
        width: 22px;
        height: 22px;
      }

      /* ìƒë‹¨ íƒ€ì´ë¨¸ */
      #hud {
        position: absolute;
        top: 3vh;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.75);
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 4.5vw;
        font-weight: 700;
        z-index: 30;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }
      /* ìº”ë²„ìŠ¤ */
      canvas#gameCanvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      /* ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ */
      #overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0);
        z-index: 40;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        transition: background 0.25s;
      }
      #modal {
        width: 86vw;
        max-width: 540px;
        background: var(--panel-bg);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        transform: scale(0.96);
        opacity: 0;
        transition: all 0.18s;
        pointer-events: auto;
      }
      #modal.show {
        transform: scale(1);
        opacity: 1;
      }
      #modal h2 {
        margin: 0 0 8px 0;
        font-size: 1.15rem;
        text-align: center;
      }
      #modal .sub {
        font-size: 0.95rem;
        color: #333;
        text-align: center;
        margin-bottom: 12px;
      }
      /* ì…ë ¥ & leaderboard */
      #nameInput {
        width: 100%;
        padding: 8px 10px;
        font-size: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
      }
      #leaderboard {
        max-height: 40vh;
        overflow: auto;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      th,
      td {
        padding: 6px 8px;
        text-align: left;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.06);
      }
      th.rank {
        width: 12%;
      }
      th.name {
        width: 50%;
      }
      th.time {
        width: 38%;
        text-align: right;
      }
      tr {
        background: transparent;
      }

      /* ---------- leaderboard top 3 styles ---------- */
      /* tr ìì²´ ìŠ¤íƒ€ì¼ (ë°°ê²½/í…Œë‘ë¦¬/ì• ë‹ˆë©”ì´ì…˜) */
      #lbBody tr.rank-1 td,
      #lbBody tr.rank-2 td,
      #lbBody tr.rank-3 td {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        border-radius: 8px;
      }

      /* hover íš¨ê³¼ (ì„ íƒì‚¬í•­) */
      #lbBody tr.rank-1:hover,
      #lbBody tr.rank-2:hover,
      #lbBody tr.rank-3:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
      }

      /* 1ë“± */
      #lbBody tr.rank-1 {
        background: linear-gradient(90deg, #fff7e6, #fff0c2);
      }
      #lbBody tr.rank-1 .rank {
        font-weight: 900;
        font-size: 1.15rem;
        color: #b57800; /* gold-ish */
      }
      #lbBody tr.rank-1 .name {
        font-weight: 800;
        font-size: 1.05rem;
      }
      #lbBody tr.rank-1 .time {
        font-weight: 800;
        font-size: 1.05rem;
      }

      /* 2ë“± */
      #lbBody tr.rank-2 {
        background: linear-gradient(90deg, #f6f8fb, #e9eef6);
      }
      #lbBody tr.rank-2 .rank {
        font-weight: 800;
        font-size: 1.05rem;
        color: #7d8aa3; /* silver-ish */
      }
      #lbBody tr.rank-2 .name,
      #lbBody tr.rank-2 .time {
        font-weight: 700;
      }

      /* 3ë“± */
      #lbBody tr.rank-3 {
        background: linear-gradient(90deg, #fff6f1, #ffeadd);
      }
      #lbBody tr.rank-3 .rank {
        font-weight: 800;
        font-size: 1.02rem;
        color: #a05500; /* bronze-ish */
      }
      #lbBody tr.rank-3 .name,
      #lbBody tr.rank-3 .time {
        font-weight: 700;
      }

      /* medal/icon cell ìŠ¤íƒ€ì¼ (rank cell ê°€ìš´ë° ì •ë ¬) */
      #lbBody td.rank {
        text-align: center;
        vertical-align: middle;
        font-size: 0.95rem;
      }

      /* 1~3ë“±ì— ë©”ë‹¬ ì´ëª¨ì§€ í¬ê¸° í‚¤ìš°ê¸° */
      #lbBody tr.rank-1 td.rank::before,
      #lbBody tr.rank-2 td.rank::before,
      #lbBody tr.rank-3 td.rank::before {
        display: inline-block;
        margin-right: 6px;
        font-size: 1.15rem;
        transform: translateY(1px);
      }

      /* ìˆ¨ê¹€ ì²˜ë¦¬(ìŠ¤ë§ˆíŠ¸): ì¼ë°˜ í–‰ê³¼ì˜ êµ¬ë¶„ì„ ë” ë¶€ë“œëŸ½ê²Œ */
      #lbBody tr:not(.rank-1):not(.rank-2):not(.rank-3) td {
        opacity: 0.95;
      }

      /* ë²„íŠ¼ row */
      .btn-row {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }
      .btn {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        border: none;
        font-weight: 700;
      }
      .btn.restart {
        background: #00aaff;
        color: white;
      }
      .btn.home {
        background: #f0f0f0;
        color: #111;
      }

      /* ì•ˆë‚´ í…ìŠ¤íŠ¸ (ìˆ¨ê¸¸ ìˆ˜ ìˆìŒ) */
      #hint {
        position: absolute;
        left: 10px;
        bottom: 8vh;
        font-size: 3.5vw;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        z-index: 20;
      }

      @media (min-width: 600px) {
        #hud {
          font-size: 22px;
        }
        #modal h2 {
          font-size: 1.25rem;
        }
        #hint {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div id="game-wrap">
      <div id="hud">0.0s</div>

      <!-- ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ í‘œì‹œ(ê²Œì„ í™”ë©´ì—ì„œë„) -->
      <div class="sound-controls" id="soundControls">
        <div class="sound-btn" id="waveToggleBtn">
          <img
            id="waveIcon"
            src="https://img.icons8.com/ios-filled/50/000000/speaker.png"
            alt="wave"
          />
          <span style="font-size: 3.4vw">íŒŒë„</span>
        </div>
        <div class="sound-btn" id="musicToggleBtn">
          <img
            id="musicIcon"
            src="https://img.icons8.com/ios-filled/50/000000/speaker.png"
            alt="music"
          />
          <span style="font-size: 3.4vw">ìŒì•…</span>
        </div>
      </div>

      <canvas id="gameCanvas"></canvas>

      <!-- overlay/modal ë¹„í™œì„± ìƒíƒœ(íˆ¬ëª…) -->
      <div id="overlay" aria-hidden="true">
        <div id="modal" role="dialog" aria-modal="true">
          <h2>ê²Œì„ ì¢…ë£Œ</h2>
          <div class="sub">ìƒì¡´ ì‹œê°„: <span id="finalTime">0.0</span> ì´ˆ</div>

          <input
            id="nameInput"
            placeholder="í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 21322 ì „ê·œí˜„)"
            maxlength="30"
          />

          <div id="leaderboard">
            <table>
              <thead>
                <tr>
                  <th class="rank">ë“±ìˆ˜</th>
                  <th class="name">ì´ë¦„</th>
                  <th class="time">ê¸°ë¡(ì´ˆ)</th>
                </tr>
              </thead>
              <tbody id="lbBody"></tbody>
            </table>
          </div>

          <div class="btn-row">
            <button class="btn restart" id="restartBtn">ì¬ì‹œì‘</button>
            <button class="btn home" id="homeBtn">í™ˆìœ¼ë¡œ</button>
          </div>
        </div>
      </div>

      <!-- ìˆ¨ê²¨ì§„ ìœ íŠœë¸Œ í”Œë ˆì´ì–´ (íŒŒë„/ìŒì•…) -->
      <iframe
        id="wavePlayer"
        src="https://www.youtube.com/embed/n4Mdh3TEq_k?enablejsapi=1&loop=1&playlist=n4Mdh3TEq_k"
        width="0"
        height="0"
        frameborder="0"
        allow="autoplay"
      ></iframe>
      <iframe
        id="musicPlayer"
        src="https://www.youtube.com/embed/MWRb7zOxxdg?enablejsapi=1&loop=1&playlist=MWRb7zOxxdg"
        width="0"
        height="0"
        frameborder="0"
        allow="autoplay"
      ></iframe>

      <!-- ê°„ë‹¨ ì•ˆë‚´ -->
      <div id="hint">ê¸°ìš¸ì—¬ì„œ ì´ë™í•˜ì„¸ìš”!</div>
    </div>

    <script>
      /* ====== ê²Œì„ ì„¤ì • ====== */
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      let W = (canvas.width = innerWidth);
      let H = (canvas.height = innerHeight);
      let hasSavedThisRun = false;
      let currentRunId = null; // í˜„ì¬ í”Œë ˆì´ ì„¸ì…˜ ê³ ìœ  ID

      window.addEventListener('resize', () => {
        W = canvas.width = innerWidth;
        H = canvas.height = innerHeight;
        player.r = Math.max(
          20,
          Math.min(48, Math.round(Math.min(W, H) * 0.05))
        );
      });

      /* ===== ì´ë¯¸ì§€ ë¡œë“œ(í”„ë¦¬ë¡œë“œ) ===== */
      const playerImg = new Image();
      playerImg.src = 'ìƒˆìš°ê¹¡.png'; // ìƒëŒ€ê²½ë¡œ í™•ì¸
      const seagullImg = new Image();
      seagullImg.src = 'ê°ˆë§¤ê¸°.png';

      let assetsToLoad = 2;
      function assetLoaded() {
        assetsToLoad--;
        if (assetsToLoad <= 0) {
          startGameLoop();
        }
      }
      playerImg.onload = assetLoaded;
      seagullImg.onload = assetLoaded;
      // ì•ˆì „ íƒ€ì„ì•„ì›ƒ: ì´ë¯¸ì§€ ë¡œë“œ ì§€ì—° ì‹œì—ë„ ì‹œì‘
      setTimeout(() => {
        if (assetsToLoad > 0) startGameLoop();
      }, 1500);

      /* í”Œë ˆì´ì–´ */
      const player = {
        x: W / 2,
        y: H / 2, // ì‹œì‘ ìœ„ì¹˜: í™”ë©´ ì¤‘ì•™
        r: Math.max(20, Math.min(48, Math.round(Math.min(W, H) * 0.05))),
        vx: 0,
        vy: 0,
      };

      /* ê°ˆë§¤ê¸° ë¦¬ìŠ¤íŠ¸ */
      const birds = [];

      /* ìŠ¤í° ì œì–´ */
      let spawnInterval = 1500; // ì´ˆê¸° ìŠ¤í° ê°„ê²© ms
      let spawnTimer = 0;
      let spawnAcceleration = 0.985;
      const minSpawnInterval = 450;

      // ì¶©ëŒ ê°ë„ ì„¤ì • (ì‘ì„ìˆ˜ë¡ ì¶©ëŒíŒì •ì´ ì‘ì•„ì§ â€” ì¡°ì • ê°€ëŠ¥)
      const COLLISION_FACTOR = { player: 0.85, bird: 0.55 };

      /* ê²Œì„ ë£¨í”„, ì‹œê°„ ì¸¡ì • */
      let running = true;
      let startTime = null;
      let elapsed = 0;
      let displayTimerEl = document.getElementById('hud');
      let lastFrame = performance.now();

      /* ëœë¤ í—¬í¼ */
      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }

      /* ====== ìì´ë¡œ(ëª¨ì…˜) ê¶Œí•œ + ì²˜ë¦¬ (iOS ëŒ€ì‘ + í„°ì¹˜ í´ë°± í¬í•¨) ====== */
      let calibration = null; // {g, b}
      let tilt = { x: 0, y: 0 };
      let useGyro = false;
      let gyroEnabled = false; // ì‹¤ì œë¡œ ë¦¬ìŠ¤ë„ˆê°€ ë¶™ì—ˆëŠ”ì§€ ì—¬ë¶€
      let gyroPromptEl = null;

      // (1) ì‹¤ì œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ â€” ê°’ ê²€ì¦/ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í¬í•¨
      function handleOrientation(e) {
        // e.gamma, e.beta ê°€ ìœ íš¨í•œ ìˆ«ìì¸ì§€ ë¨¼ì € í™•ì¸
        const g = typeof e.gamma === 'number' ? e.gamma : null;
        const b = typeof e.beta === 'number' ? e.beta : null;

        if (g === null || b === null) {
          // ìœ íš¨í•˜ì§€ ì•ŠìŒ â†’ ì‚¬ìš© ì•ˆ í•¨
          return;
        }

        // ìµœì´ˆ ì´ë²¤íŠ¸ì—ì„œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì„ ì €ì¥ (ì¤‘ë¦½)
        if (!calibration) {
          calibration = { g, b };
          console.log('Gyro calibrated:', calibration);
        }

        // tilt ê³„ì‚° ë° í´ë¨í•‘
        tilt.x = Math.max(-40, Math.min(40, g - calibration.g));
        tilt.y = Math.max(-40, Math.min(40, b - calibration.b));
        useGyro = true;
        // ë””ë²„ê·¸: HUD ìš°ì¸¡ ìƒë‹¨ì— ìƒíƒœ í‘œì‹œ (ì„ íƒ)
        if (displayTimerEl) {
          displayTimerEl.dataset.g = tilt.x.toFixed(1);
          displayTimerEl.dataset.b = tilt.y.toFixed(1);
        }
      }

      // (2) iOS ê¶Œí•œ ìš”ì²­ + ë¦¬ìŠ¤ë„ˆ ë¶€ì°© í•¨ìˆ˜
      function enableGyroWithPermission() {
        // ì´ë¯¸ ì²˜ë¦¬ëìœ¼ë©´ ë¬´ì‹œ
        if (gyroEnabled) return Promise.resolve(true);

        // iOS (DeviceOrientationEvent.requestPermission) ì²´í¬
        if (
          typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function'
        ) {
          // iOS: ì‚¬ìš©ì ì œìŠ¤ì²˜(ë²„íŠ¼/í„°ì¹˜)ë¡œ ìš”ì²­í•´ì•¼ í•¨
          return DeviceMotionEvent.requestPermission()
            .then((result) => {
              if (result === 'granted') {
                attachGyroListener();
                return true;
              } else {
                console.warn('Gyro permission denied on iOS:', result);
                return false;
              }
            })
            .catch((err) => {
              console.error('Gyro permission request error:', err);
              return false;
            });
        } else {
          // ê¸°íƒ€ ë¸Œë¼ìš°ì €: ë°”ë¡œ ë¶™ì—¬ë„ ë¨(ë‹¨, https í•„ìš”)
          try {
            attachGyroListener();
            return Promise.resolve(true);
          } catch (e) {
            console.error('attachGyroListener failed:', e);
            return Promise.resolve(false);
          }
        }
      }

      function attachGyroListener() {
        if (gyroEnabled) return;
        window.addEventListener('deviceorientation', handleOrientation, true);
        gyroEnabled = true;
        console.log('Gyro listener attached');
        hideGyroPrompt();
      }

      // (3) í”„ë¡¬í”„íŠ¸ UI (ì‚¬ìš©ì ì œìŠ¤ì²˜ë¥¼ ìœ ë„)
      function showGyroPrompt() {
        if (gyroPromptEl) return;
        gyroPromptEl = document.createElement('div');
        gyroPromptEl.style.position = 'absolute';
        gyroPromptEl.style.left = '50%';
        gyroPromptEl.style.top = '10vh';
        gyroPromptEl.style.transform = 'translateX(-50%)';
        gyroPromptEl.style.background = 'rgba(255,255,255,0.95)';
        gyroPromptEl.style.padding = '8px 12px';
        gyroPromptEl.style.borderRadius = '10px';
        gyroPromptEl.style.zIndex = '60';
        gyroPromptEl.style.fontSize = '14px';
        gyroPromptEl.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
        gyroPromptEl.textContent =
          'ìì´ë¡œ(ê¸°ìš¸ê¸°) ì‚¬ìš©ì„ í—ˆìš©í•˜ë ¤ë©´ í„°ì¹˜í•˜ì„¸ìš” (ì‹œì‘í•  ë•Œ í•¸ë“œí° ê°ë„ê°€ ì›€ì§ì¼ ë•Œ ê¸°ì¤€)';
        gyroPromptEl.addEventListener('click', onGyroPromptClick);
        document.getElementById('game-wrap').appendChild(gyroPromptEl);
      }

      function hideGyroPrompt() {
        if (!gyroPromptEl) return;
        try {
          gyroPromptEl.removeEventListener('click', onGyroPromptClick);
          gyroPromptEl.remove();
        } catch (_) {}
        gyroPromptEl = null;
      }

      function onGyroPromptClick() {
        // ì‚¬ìš©ì ì œìŠ¤ì²˜ ë°œìƒ â€” ê¶Œí•œ ìš”ì²­ ì‹œë„
        enableGyroWithPermission().then((granted) => {
          if (granted) {
            console.log('Gyro enabled by user gesture');
            hideGyroPrompt();
          } else {
            console.warn('Gyro not enabled (user denied or unsupported)');
            // ê³„ì†í•´ì„œ í„°ì¹˜ í´ë°± í—ˆìš© â€” hideëŠ” í•˜ì§€ ì•ŠìŒ
          }
        });
      }

      /* (4) ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ì— ìë™ìœ¼ë¡œ ê¶Œí•œ ìš”ì²­ ì‹œë„ (ì•ˆë“œë¡œì´ë“œ/iOS ì•ˆì •ì„± í–¥ìƒ) */
      function setupGyroAutoRequest() {
        const handler = (e) => {
          // ì²« ì œìŠ¤ì²˜ì—ì„œ ê¶Œí•œ ìš”ì²­ ì‹œë„ (í•œ ë²ˆë§Œ)
          enableGyroWithPermission().then((granted) => {
            if (!granted) {
              // í—ˆìš© ì•ˆ ë˜ë©´ í”„ë¡¬í”„íŠ¸ ë…¸ì¶œ
              showGyroPrompt();
            } else {
              hideGyroPrompt();
            }
          });
          window.removeEventListener('touchstart', handler);
          window.removeEventListener('pointerdown', handler);
        };
        window.addEventListener('touchstart', handler, { once: true });
        window.addEventListener('pointerdown', handler, { once: true });
        // ì¶”ê°€ë¡œ, í˜ì´ì§€ ë¡œë“œ ì§í›„ í”„ë¡¬í”„íŠ¸ë„ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŒ
        showGyroPrompt();
      }

      // (5) í„°ì¹˜ í´ë°±: ìì´ë¡œê°€ ì—†ì„ ë•Œ í„°ì¹˜ ë“œë˜ê·¸ë¡œ ì´ë™ì‹œí‚¤ëŠ” ê°„ë‹¨ ëŒ€ì²´ ì œì–´
      let touchControlActive = false;
      let touchLast = null;
      function onPointerDownForTouchControl(e) {
        touchControlActive = true;
        touchLast = { x: e.clientX, y: e.clientY };
      }
      function onPointerMoveForTouchControl(e) {
        if (!touchControlActive || useGyro) return;
        if (!touchLast) {
          touchLast = { x: e.clientX, y: e.clientY };
          return;
        }
        const dx = e.clientX - touchLast.x;
        const dy = e.clientY - touchLast.y;
        // ì´ë™ëŸ‰ì„ í”Œë ˆì´ì–´ ì†ë„ì— ì¡°ê¸ˆ ì„ì–´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ë™
        player.vx += dx * 0.02;
        player.vy += dy * 0.02;
        touchLast = { x: e.clientX, y: e.clientY };
      }
      function onPointerUpForTouchControl(e) {
        touchControlActive = false;
        touchLast = null;
      }

      // ë°”ì¸ë”© (í•­ìƒ ë¶™ì—¬ë„ ì•ˆì „)
      window.addEventListener('pointerdown', onPointerDownForTouchControl);
      window.addEventListener('pointermove', onPointerMoveForTouchControl);
      window.addEventListener('pointerup', onPointerUpForTouchControl);
      window.addEventListener('pointercancel', onPointerUpForTouchControl);

      // (6) ì‹œì‘ ì‹œ ìë™ ì„¤ì • í˜¸ì¶œ â€” startGameLoop ë˜ëŠ” ì´ˆê¸°í™” ì‹œ í˜¸ì¶œ
      // setupGyroAutoRequest();  <-- startGameLoop()ê°€ í˜¸ì¶œë  ë•Œ ì´ ì¤„ì„ í™œì„±í™”í•˜ì„¸ìš”

      /* í‚¤ë³´ë“œ fallback */
      const keys = {};
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
      });
      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
      });

      /* ê°ˆë§¤ê¸° ìƒì„±: í™”ë©´ ë°”ê¹¥ì—ì„œ ëœë¤ ìœ„ì¹˜, ì‹œì‘ ë°©í–¥ì„ í”Œë ˆì´ì–´ ìª½ìœ¼ë¡œ, í¬ê¸° 3ë°° */
      function spawnBird() {
        const side = Math.floor(Math.random() * 4);
        let x, y;

        // ê°ˆë§¤ê¸° ì´ë™ ì†ë„: ë§¤ìš° ëŠë¦° ë²”ìœ„ (ì›í•˜ì‹œë©´ ë¯¸ì„¸ ì¡°ì • ê°€ëŠ¥)
        const speed = rand(0.018, 0.048) * (Math.min(W, H) / 800 + 0.6);

        // base size => 3ë°° í™•ëŒ€
        const base = Math.round(
          rand(Math.min(W, H) * 0.018, Math.min(W, H) * 0.035)
        );
        // 3ë°° í•˜ë˜ í™”ë©´ë¹„ìœ¨ë¡œ ìƒí•œì„ ë‘ 
        const r = Math.min(Math.max(12, base * 3), Math.min(W, H) * 0.28);

        // spawn ìœ„ì¹˜ (outside)
        if (side === 0) {
          x = rand(-0.05 * W, 1.05 * W);
          y = -r * 2;
        } else if (side === 1) {
          x = W + r * 2;
          y = rand(-0.05 * H, 1.05 * H);
        } else if (side === 2) {
          x = rand(-0.05 * W, 1.05 * W);
          y = H + r * 2;
        } else {
          x = -r * 2;
          y = rand(-0.05 * H, 1.05 * H);
        }

        // ë°©í–¥ì„ í”Œë ˆì´ì–´ ìª½ìœ¼ë¡œ í–¥í•˜ê²Œ (ë‹¨ìœ„ë²¡í„° * speed)
        let dx = player.x - x;
        let dy = player.y - y;
        let len = Math.hypot(dx, dy);
        if (len < 1) {
          dx = rand(-0.5, 0.5);
          dy = rand(-0.5, 0.5);
          len = Math.hypot(dx, dy) || 1;
        }
        let vx = (dx / len) * speed;
        let vy = (dy / len) * speed;

        // ì•½ê°„ ëœë¤ í”ë“¤ê¸°
        vx += rand(-0.01, 0.01);
        vy += rand(-0.01, 0.01);

        birds.push({ x, y, vx, vy, r, angle: 0, img: seagullImg });
      }

      /* ====== ì‚¬ìš´ë“œ í† ê¸€ UI ë¡œì§ ====== */
      let waveYT, musicYT;
      let wavePlaying = true;
      let musicPlaying = true;

      const waveIconEl = document.getElementById('waveIcon');
      const musicIconEl = document.getElementById('musicIcon');
      const waveToggleBtn = document.getElementById('waveToggleBtn');
      const musicToggleBtn = document.getElementById('musicToggleBtn');

      function updateWaveIcon() {
        waveIconEl.src = wavePlaying
          ? 'https://img.icons8.com/ios-filled/50/000000/speaker.png'
          : 'https://img.icons8.com/ios-filled/50/000000/mute.png';
      }
      function updateMusicIcon() {
        musicIconEl.src = musicPlaying
          ? 'https://img.icons8.com/ios-filled/50/000000/speaker.png'
          : 'https://img.icons8.com/ios-filled/50/000000/mute.png';
      }

      waveToggleBtn.addEventListener('click', () => {
        wavePlaying = !wavePlaying;
        if (waveYT && waveYT.playVideo) {
          try {
            if (wavePlaying) waveYT.playVideo();
            else waveYT.pauseVideo();
          } catch (e) {}
        }
        updateWaveIcon();
      });
      musicToggleBtn.addEventListener('click', () => {
        musicPlaying = !musicPlaying;
        if (musicYT && musicYT.playVideo) {
          try {
            if (musicPlaying) musicYT.playVideo();
            else musicYT.pauseVideo();
          } catch (e) {}
        }
        updateMusicIcon();
      });

      /* ë©”ì¸ ì—…ë°ì´íŠ¸/ë Œë” ë£¨í”„ */
      function update(dt) {
        if (!running) return;
        if (startTime === null) startTime = performance.now();
        elapsed = (performance.now() - startTime) / 1000;

        // spawn logic
        spawnTimer += dt;
        if (spawnTimer >= spawnInterval) {
          spawnBird();
          spawnTimer = 0;
          spawnInterval = Math.max(
            minSpawnInterval,
            spawnInterval * spawnAcceleration
          );
        }

        // update birds
        for (let i = birds.length - 1; i >= 0; i--) {
          const b = birds[i];
          b.x += b.vx * dt * 0.06 * 60;
          b.y += b.vy * dt * 0.06 * 60;
          b.angle += 0.02;
          if (b.x < -b.r * 4 && b.vx < 0) birds.splice(i, 1);
          else if (b.x > W + b.r * 4 && b.vx > 0) birds.splice(i, 1);
          else if (b.y < -b.r * 4 && b.vy < 0) birds.splice(i, 1);
          else if (b.y > H + b.r * 4 && b.vy > 0) birds.splice(i, 1);
        }

        // player movement
        let accelX = 0,
          accelY = 0;

        if (useGyro) {
          const normX = tilt.x / 40; // -1..1
          const normY = tilt.y / 40;
          const sensitivity = Math.min(W, H) / 700;
          accelX = normX * sensitivity;
          accelY = normY * sensitivity;
        } else {
          // í‚¤ë³´ë“œ fallback (ë°ìŠ¤í¬íƒ‘ í…ŒìŠ¤íŠ¸ìš©)
          const speed = Math.min(W, H) * 50;
          if (keys['arrowleft'] || keys['a']) accelX = -speed;
          if (keys['arrowright'] || keys['d']) accelX = speed;
          if (keys['arrowup'] || keys['w']) accelY = -speed;
          if (keys['arrowdown'] || keys['s']) accelY = speed;
        }

        // smoothing velocity & clamp
        player.vx += (accelX - player.vx) * 0.12;
        player.vy += (accelY - player.vy) * 0.12;
        player.x += player.vx * dt * 0.06 * 60;
        player.y += player.vy * dt * 0.06 * 60;

        // clamp inside screen
        player.x = Math.max(player.r, Math.min(W - player.r, player.x));
        player.y = Math.max(player.r, Math.min(H - player.r, player.y));

        // collision detect
        for (const b of birds) {
          const d = Math.hypot(player.x - b.x, player.y - b.y);

          // effective radii: ì´ë¯¸ì§€ íˆ¬ëª…/ì—¬ë°± ë•Œë¬¸ì— ì‹¤ì œ ë³´ì´ëŠ” ë¶€ë¶„ë³´ë‹¤ ì‘ê²Œ ì„¤ì •
          const effectivePlayerR = player.r * COLLISION_FACTOR.player;
          const effectiveBirdR = b.r * COLLISION_FACTOR.bird;

          if (d < effectivePlayerR + effectiveBirdR) {
            endGame();
            break;
          }
        }

        displayTimerEl.textContent = elapsed.toFixed(1) + 's';
      }

      function render() {
        ctx.clearRect(0, 0, W, H);

        // draw birds (image or fallback)
        for (const b of birds) {
          ctx.save();
          ctx.translate(b.x, b.y);
          ctx.rotate(Math.sin(b.angle) * 0.15);
          if (b.img && b.img.complete) {
            ctx.drawImage(b.img, -b.r, -b.r, b.r * 2, b.r * 2);
          } else {
            ctx.beginPath();
            ctx.fillStyle = 'white';
            ctx.arc(0, 0, b.r, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();
        }

        // draw player (image or fallback)
        ctx.save();
        ctx.translate(player.x, player.y);
        if (playerImg && playerImg.complete) {
          ctx.drawImage(
            playerImg,
            -player.r,
            -player.r,
            player.r * 2,
            player.r * 2
          );
        } else {
          ctx.beginPath();
          ctx.fillStyle = '#1e90ff';
          ctx.arc(0, 0, player.r, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();
      }

      /* main loop */
      function gameLoop(now) {
        const dt = now - lastFrame;
        lastFrame = now;
        update(dt);
        render();
        if (running) requestAnimationFrame(gameLoop);
      }

      /* ====== ê²Œì„ ì¢…ë£Œ ë° ë¦¬ë”ë³´ë“œ ì²˜ë¦¬ ====== */
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('modal');
      const finalTimeEl = document.getElementById('finalTime');
      const nameInput = document.getElementById('nameInput');
      const lbBody = document.getElementById('lbBody');
      const restartBtn = document.getElementById('restartBtn');
      const homeBtn = document.getElementById('homeBtn');

      function endGame() {
        running = false;
        finalTimeEl.textContent = elapsed.toFixed(1);
        overlay.style.background = 'rgba(0,0,0,0.5)';
        overlay.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');

        // âŒ ì—¬ê¸°ëŠ” ì´ì œ addRecord() í•„ìš” ì—†ìŒ!
        // âœ… ì´ë¦„ ì…ë ¥ í›„ í™•ì¸ ë²„íŠ¼(ë˜ëŠ” ì—”í„°)ì„ ëˆŒë €ì„ ë•Œë§Œ commitNameAndSave() ì‹¤í–‰ë¨

        setTimeout(() => nameInput.focus(), 200);
      }

      /* leaderboard (Supabase ë²„ì „ - ì•ˆì •í™” ë° ì‹¤ì‹œê°„ ë°˜ì˜ ë²„ì „) */

      // Supabase ì´ˆê¸°í™”
      const SUPABASE_URL = 'https://zvzlkxwxehjzalbxokrq.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2emxreHd4ZWhqemFsYnhva3JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTM0ODMsImV4cCI6MjA3NjE2OTQ4M30.73PB3JDOIPWBj1RtHf47s2geEwx20Cg4YgklOWf2aE0';
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // ë¡œì»¬ ìºì‹œ í‚¤ (ë°±ì—…ìš©)
      const LS_KEY = 'seagull_leaderboard_v1';

      // âœ… DBì—ì„œ ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
      async function readLB() {
        try {
          const { data, error } = await supabase
            .from('galmaegi')
            .select('name, survive_time')
            .order('survive_time', { ascending: false });

          if (error) throw error;
          return data.map((r) => ({ name: r.name, time: r.survive_time }));
        } catch (e) {
          console.error('readLB error:', e);
          return [];
        }
      }

      // âœ… DBì— ê¸°ë¡ ì¶”ê°€ (ì—…ë°ì´íŠ¸ + ì¦‰ì‹œ ë°˜ì˜)
      async function addRecord(name, time, runId) {
        const t = Number(time);

        // ì´ë¦„ì´ ë¹„ì—ˆìœ¼ë©´ DB ì €ì¥ ì•ˆ í•¨
        if (!name || name.trim() === '') {
          console.warn('âš ï¸ ì´ë¦„ì´ ë¹„ì–´ ìˆì–´ì„œ ê¸°ë¡ ì €ì¥ ì•ˆ í•¨');
          return false;
        }

        try {
          // ê¸°ì¡´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
          const { data: existing, error: selErr } = await supabase
            .from('galmaegi')
            .select('id, survive_time')
            .eq('name', name)
            .maybeSingle(); // single() ëŒ€ì‹  maybeSingle() â†’ ì—†ëŠ” ê²½ìš° ì—ëŸ¬ ì•ˆ ë˜ì§

          if (selErr) throw selErr;

          let updated = false;

          if (existing) {
            // ê¸°ì¡´ ê¸°ë¡ì´ ë” í¬ë©´ ë¬´ì‹œ
            if (Number(existing.survive_time) >= t) {
              console.log('ì´ì „ ê¸°ë¡ì´ ë” ë†’ìŒ â†’ ê°±ì‹  ì•ˆ í•¨');
            } else {
              // ê°±ì‹ 
              const { error: upErr } = await supabase
                .from('galmaegi')
                .update({ survive_time: t })
                .eq('id', existing.id);
              if (upErr) throw upErr;
              updated = true;
            }
          } else {
            // ì‹ ê·œ ì¶”ê°€
            const { error: insErr } = await supabase
              .from('galmaegi')
              .insert([{ name, survive_time: t }]);
            if (insErr) throw insErr;
            updated = true;
          }

          // âœ… DB ë°˜ì˜ ì„±ê³µ ì‹œ ë¡œì»¬ ìºì‹œ ê°±ì‹  + ë¦¬ë”ë³´ë“œ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
          if (updated) {
            localStorage.setItem(LS_KEY, JSON.stringify({ name, time: t }));
            console.log('âœ… ê¸°ë¡ ì¶”ê°€ ì™„ë£Œ, ë¦¬ë”ë³´ë“œ ê°±ì‹  ì¤‘...');
            await populateLeaderboard(); // ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ ê°±ì‹ 
          }

          return updated;
        } catch (e) {
          console.error('addRecord error:', e);
          return false;
        }
      }

      // âœ… ë¦¬ë”ë³´ë“œ í‘œì‹œ í•¨ìˆ˜
      async function populateLeaderboard() {
        const arr = await readLB();
        lbBody.innerHTML = '';

        if (!arr || arr.length === 0) {
          lbBody.innerHTML =
            '<tr><td colspan="3" style="text-align:center;color:#666;padding:12px">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }

        arr.forEach((r, i) => {
          const tr = document.createElement('tr');

          if (i === 0) tr.classList.add('rank-1');
          else if (i === 1) tr.classList.add('rank-2');
          else if (i === 2) tr.classList.add('rank-3');

          const rankTd = document.createElement('td');
          rankTd.className = 'rank';
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '';
          rankTd.innerHTML = (medal ? `${medal} ` : '') + (i + 1);

          const nm = document.createElement('td');
          nm.className = 'name';
          nm.textContent = r.name;

          const t = document.createElement('td');
          t.className = 'time';
          t.style.textAlign = 'right';
          t.textContent = Number(r.time).toFixed(1);

          tr.appendChild(rankTd);
          tr.appendChild(nm);
          tr.appendChild(t);

          lbBody.appendChild(tr);
        });
      }

      /* ì´í•˜ ë¶€ë¶„ (disableNameInput, commitNameAndSave ë“±) ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš© */

      // helper: ì…ë ¥ ì ê¸ˆ/í•´ì œ (ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      function disableNameInput() {
        nameInput.disabled = true;
        nameInput.style.opacity = 0.6;
      }
      function enableNameInput() {
        nameInput.disabled = false;
        nameInput.style.opacity = 1;
      }

      // ì €ì¥ ë²„íŠ¼(optional) ì°¸ì¡°: ì•„ë˜ì—ì„œ saveBtnì„ ë§Œë“¤ë©´ ì‚¬ìš©
      let saveBtn = null; // ì—†ìœ¼ë©´ null

      // ì—”í„°/ë²„íŠ¼ ì¤‘ë³µ ì‹¤í–‰ì„ ë§‰ëŠ” ì¼ì›í™”ëœ í•¨ìˆ˜
      function commitNameAndSave() {
        // ì´ë¯¸ ì €ì¥í–ˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
        if (hasSavedThisRun) return;

        hasSavedThisRun = true; // ì €ì¥ ì¤‘ ì ê¸ˆ
        disableNameInput();
        if (saveBtn) saveBtn.disabled = true;

        // âœ… ì´ë¦„ ì…ë ¥ê°’ í™•ì •
        const playerName = nameInput.value.trim();
        const finalName = playerName !== '' ? playerName : 'ìµëª…';

        // âœ… 'ìµëª…' ë˜ëŠ” 'ë¬´ëª…'ì¼ ê²½ìš° ì €ì¥í•˜ì§€ ì•ŠìŒ
        const blockedNames = ['ìµëª…', 'ë¬´ëª…'];
        if (blockedNames.includes(finalName)) {
          console.warn('âš ï¸ ì´ë¦„ì´ ìµëª…/ë¬´ëª…ì´ë¼ ê¸°ë¡ ì €ì¥ ì•ˆ í•¨');
          // ì´ë¦„ ì…ë ¥ ë‹¤ì‹œ ê°€ëŠ¥í•˜ê²Œ ë³µêµ¬ (ì„ íƒì‚¬í•­)
          enableNameInput();
          hasSavedThisRun = false; // ë‹¤ì‹œ ì…ë ¥ í—ˆìš©
          return false;
        }

        // âœ… ì ìˆ˜ ê¸°ë¡ ì¶”ê°€ (ì´ íƒ€ì´ë°ì—ë§Œ addRecord í˜¸ì¶œ)
        const didUpdate = addRecord(
          finalName,
          elapsed.toFixed(1),
          currentRunId
        );

        // âœ… ë¦¬ë”ë³´ë“œ ê°±ì‹ 
        populateLeaderboard();

        // âœ… ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì œê±° (ëª¨ë°”ì¼ì—ì„œ ì¤‘ë³µ ë°œìƒ ë°©ì§€)
        try {
          nameInput.blur();
        } catch (e) {}

        return didUpdate;
      }

      // ì•ˆì „í•˜ê²Œ ì—¬ëŸ¬ ì…ë ¥ ë°©ì‹ì„ ìˆ˜ì‹ í•˜ë„ë¡ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      function attachNameInputHandlers() {
        // remove any previous listeners to avoid duplicates
        nameInput.removeEventListener('keydown', onNameKey);
        nameInput.removeEventListener('keyup', onNameKey);
        nameInput.removeEventListener('blur', onNameBlur);
        // attach
        nameInput.addEventListener('keydown', onNameKey);
        nameInput.addEventListener('keyup', onNameKey);
        nameInput.addEventListener('blur', onNameBlur);
      }

      // handler: í‚¤(ì—”í„°) ì²˜ë¦¬
      function onNameKey(e) {
        // keyCode 13 or key 'Enter' ì²˜ë¦¬ (ëª¨ë°”ì¼ IME ëŒ€ë¹„)
        const isEnter = e.key === 'Enter' || e.keyCode === 13;
        if (isEnter) {
          e.preventDefault();
          commitNameAndSave();
        }
      }

      // handler: í¬ì»¤ìŠ¤ê°€ ë– ë‚  ë•Œë„ ì €ì¥ ì‹œë„ (ì‚¬ìš©ìê°€ Done ëˆ„ë¥´ê³  ë‹¤ë¥¸ ê³³ ëˆ„ë¥¼ ë•Œ)
      function onNameBlur(e) {
        // ì €ì¥ ì•ˆ í–ˆìœ¼ë©´ ì‹œë„
        if (!hasSavedThisRun) {
          commitNameAndSave();
        }
      }

      // attach handlers now
      attachNameInputHandlers();

      restartBtn.addEventListener('click', () => {
        modal.classList.remove('show');
        overlay.style.background = 'rgba(0,0,0,0)';
        overlay.setAttribute('aria-hidden', 'true');
        resetGame();
        running = true;
        startTime = null;
        spawnInterval = 1500;
        spawnTimer = 0;
        lastFrame = performance.now();
        requestAnimationFrame(gameLoop);
      });
      homeBtn.addEventListener('click', () => {
        location.href = 'index.html';
      });

      function resetGame() {
        birds.length = 0;
        player.x = W / 2; // ì‹œì‘ ìœ„ì¹˜ ì¤‘ì•™ ê³ ì •
        player.y = H / 2;
        player.vx = 0;
        player.vy = 0;
        elapsed = 0;
        calibration = null; // ì¬ì‹œì‘ ì‹œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë‹¤ì‹œ ë°›ë„ë¡

        // ë¦¬ì…‹ ì‹œ ì´ë¦„ ì…ë ¥ ìƒíƒœ ì´ˆê¸°í™”
        currentRunId = Date.now(); // ì´ ê²Œì„ ì„¸ì…˜ì˜ ê³ ìœ  ID
        hasSavedThisRun = false;
        enableNameInput();
        nameInput.value = '';
        // (ë§Œì•½ saveBtnì„ ì¶”ê°€í–ˆë‹¤ë©´ ë¹„í™œì„±í™” í•´ì œ)
        if (typeof saveBtn !== 'undefined' && saveBtn) saveBtn.disabled = false;
      }

      /* ====== YouTube Players for sounds ====== */
      function onYouTubeIframeAPIReady() {
        waveYT = new YT.Player('wavePlayer', {
          events: {
            onReady: function (e) {
              try {
                if (wavePlaying) e.target.setVolume(60), e.target.playVideo();
                else e.target.pauseVideo();
              } catch (_) {}
            },
          },
        });
        musicYT = new YT.Player('musicPlayer', {
          events: {
            onReady: function (e) {
              try {
                if (musicPlaying) e.target.setVolume(70), e.target.playVideo();
                else e.target.pauseVideo();
              } catch (_) {}
            },
          },
        });
        // update icons initial
        updateWaveIcon();
        updateMusicIcon();
      }
      (function loadYT() {
        const s = document.createElement('script');
        s.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(s);
      })();

      // ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ë°©ì§€: ì²« í„°ì¹˜ ì‹œ ì¬ìƒ ì‹œë„
      let firstTouchHandler = function () {
        try {
          if (waveYT && waveYT.playVideo && wavePlaying) waveYT.playVideo();
          if (musicYT && musicYT.playVideo && musicPlaying) musicYT.playVideo();
        } catch (e) {}
        window.removeEventListener('touchstart', firstTouchHandler);
      };
      window.addEventListener('touchstart', firstTouchHandler, { once: true });

      /* ====== ì‹œì‘: ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ ê²Œì„ ë£¨í”„ ì‹œì‘ ====== */
      function startGameLoop() {
        if (startGameLoop.started) return;
        startGameLoop.started = true;
        resetGame();
        lastFrame = performance.now();
        requestAnimationFrame(gameLoop);

        /* ===== ë°±ê·¸ë¼ìš´ë“œ/í¬ê·¸ë¼ìš´ë“œ ê°ì§€ ë° ì¼ì‹œì •ì§€ ===== */
        let pausedAt = null;

        function pauseGame(reason = 'unknown') {
          if (running) {
            running = false;
            pausedAt = performance.now();
            console.log(`â¸ ê²Œì„ ì¼ì‹œì •ì§€ (${reason})`);

            // ì‚¬ìš´ë“œ ì •ì§€
            try {
              if (waveYT) waveYT.pauseVideo();
              if (musicYT) musicYT.pauseVideo();
            } catch (e) {}
          }
        }

        function resumeGame(reason = 'unknown') {
          // ê²Œì„ì˜¤ë²„ ìƒíƒœë©´ ì¬ê°œ ê¸ˆì§€
          if (!running && overlay.getAttribute('aria-hidden') === 'true') {
            const now = performance.now();
            if (pausedAt) {
              const pauseDuration = now - pausedAt;
              startTime += pauseDuration; // ì •ì§€ëœ ì‹œê°„ ë³´ì •
              pausedAt = null;
            }

            console.log(`â–¶ ê²Œì„ ì¬ê°œ (${reason})`);
            running = true;
            lastFrame = performance.now();
            requestAnimationFrame(gameLoop);

            // ì‚¬ìš´ë“œ ì¬ê°œ
            try {
              if (waveYT && wavePlaying) waveYT.playVideo();
              if (musicYT && musicPlaying) musicYT.playVideo();
            } catch (e) {}
          }
        }

        // âœ… ëŒ€ë¶€ë¶„ì˜ ë¸Œë¼ìš°ì €
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) pauseGame('visibilitychange');
          else resumeGame('visibilitychange');
        });

        // âœ… iOS Safari, ì¼ë¶€ ì•ˆë“œë¡œì´ë“œ í™˜ê²½
        window.addEventListener('pagehide', () => pauseGame('pagehide'));
        window.addEventListener('blur', () => pauseGame('blur'));
        window.addEventListener('focus', () => resumeGame('focus'));

        // âœ… í™ˆí™”ë©´ì—ì„œ ì•± ë³µê·€ ì‹œ(ì•ˆë“œë¡œì´ë“œ í¬ë¡¬ íŠ¹ì´ ì¼€ì´ìŠ¤)
        window.addEventListener('pageshow', (e) => {
          if (e.persisted) resumeGame('pageshow(persisted)');
        });

        setupGyroAutoRequest();
      }
    </script>
  </body>
</html>
